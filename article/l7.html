---
layout: article
title: 一个l7vpn的设想
---
      <div class="mume markdown-preview pad">

          <h2>{{ page.title }}</h2>
      <div class="mume markdown-preview  ">
      <p>&#x5148;mark&#x4E00;&#x4E0B;&#x3002;</p>
<p>&#x4E00;&#x76F4;&#x6709;&#x4E2A;&#x60F3;&#x6CD5;&#xFF0C;&#x60F3;&#x628A;<a href="http://www.notr.tech">notr</a>&#x8FD9;&#x4E2A;&#x8F6F;&#x4EF6;&#x518D;&#x6253;&#x78E8;&#x5F97;&#x66F4;&#x597D;&#x4E00;&#x70B9;&#xFF0C;&#x5F53;&#x524D;&#x4E00;&#x4E2A;&#x53CD;&#x9988;&#x5F97;&#x6BD4;&#x8F83;&#x591A;&#x7684;&#x95EE;&#x9898;&#x662F;windows&#x7248;&#x672C;&#x9700;&#x8981;&#x5B89;&#x88C5;tap&#x9A71;&#x52A8;&#xFF0C;&#x800C;&#x4E14;&#x5404;&#x4E2A;&#x5E73;&#x53F0;&#x90FD;&#x9700;&#x8981;&#x7BA1;&#x7406;&#x5458;&#x6743;&#x9650;&#xFF0C;&#x5982;&#x679C;&#x8FD9;&#x4E24;&#x4E2A;&#x95EE;&#x9898;&#x4E0D;&#x89E3;&#x51B3;&#xFF0C;&#x522B;&#x8BF4;&#x7528;&#x6237;&#x89C9;&#x5F97;&#x4E0D;&#x723D;&#x4E86;&#xFF0C;&#x6211;&#x672C;&#x8EAB;&#x5C31;&#x50CF;&#x662F;&#x675F;&#x7F1A;&#x4F4F;&#x4E86;&#x624B;&#x811A;&#xFF0C;&#x4E07;&#x4E00;&#x54EA;&#x5929;&#x60F3;&#x4E0D;&#x5F00;&#x60F3;&#x7ED9;&#x5979;&#x52A0;&#x4E0A;&#x754C;&#x9762;&#xFF0C;&#x4E5F;&#x4E0D;&#x662F;&#x90A3;&#x4E48;&#x5BB9;&#x6613;&#x3002;</p>
<p>&#x5F53;&#x524D;&#x8981;&#x89E3;&#x51B3;&#x4E0B;&#x9762;&#x4E24;&#x4E2A;&#x95EE;&#x9898;</p>
<ul>
<li>&#x53BB;&#x6389;&#x865A;&#x62DF;&#x7F51;&#x5361;</li>
<li>&#x652F;&#x6301;&#x7EC4;&#x7F51;&#xFF0C;&#x5F53;&#x524D;&#x6CA1;&#x6709;&#x7EC4;&#x7F51;&#x529F;&#x80FD;&#xFF0C;&#x4F46;&#x662F;&#x5728;&#x5F53;&#x524D;&#x57FA;&#x7840;&#x4E4B;&#x4E0A;&#xFF0C;&#x60F3;&#x8981;&#x505A;&#x5230;&#x7EC4;&#x7F51;&#x5176;&#x5B9E;&#x662F;&#x7279;&#x522B;&#x7B80;&#x5355;&#x7684;&#x3002;&#x6240;&#x4EE5;&#x8C03;&#x6574;&#x5B8C;&#x4E4B;&#x540E;&#xFF0C;&#x6211;&#x4E5F;&#x5E0C;&#x671B;&#x80FD;&#x591F;&#x5F88;&#x597D;&#x90FD;&#x9002;&#x914D;&#x7EC4;&#x7F51;&#x529F;&#x80FD;&#x3002;</li>
</ul>
<p>&#x5F88;&#x591A;vpn&#x65B9;&#x6848;&#xFF0C;&#x50CF;OpenVPN&#xFF0C;&#x90FD;&#x4F1A;&#x7528;&#x5230;&#x865A;&#x62DF;&#x7F51;&#x5361;&#xFF0C;&#x505A;&#x7684;&#x662F;&#x4E8C;&#x5C42;&#x548C;&#x4E09;&#x5C42;&#x8F6C;&#x53D1;&#xFF0C;&#x8981;&#x53BB;&#x6389;&#x865A;&#x62DF;&#x7F51;&#x5361;&#xFF0C;&#x5FC5;&#x987B;&#x9700;&#x8981;&#x53BB;&#x6389;&#x4E8C;&#x5C42;&#x548C;&#x4E09;&#x5C42;&#x8F6C;&#x53D1;&#xFF0C;&#x8981;&#x652F;&#x6301;&#x7EC4;&#x7F51;&#x529F;&#x80FD;&#xFF0C;&#x4EE5;&#x4E09;&#x5C42;&#x7EC4;&#x7F51;&#x4E3A;&#x4F8B;&#xFF0C;&#x5C31;&#x5FC5;&#x987B;&#x9700;&#x8981;&#x8981;&#x6709;IP&#x5730;&#x5740;&#x7684;&#x6982;&#x5FF5;&#x3002;&#x6240;&#x4EE5;&#x5C31;&#x8BBE;&#x60F3;&#x4E86;&#x4E0B;&#xFF1A;</p>
<p>&#x53EF;&#x4EE5;&#x7ED9;&#x6BCF;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x7F16;&#x5740;&#xFF0C;server&#x7EF4;&#x62A4;&#x7F16;&#x5740;&#x8868;&#xFF0C;<strong>&#x9488;&#x5BF9;&#x7F51;&#x7EDC;&#x5185;&#x90E8;&#x800C;&#x8A00;&#xFF0C;&#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x903B;&#x8F91;&#x5730;&#x5740;&#xFF0C;&#x6807;&#x8BC6;&#x5BA2;&#x6237;&#x7AEF;&#x800C;&#x5DF2;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x4E00;&#x8FC7;&#x7A0B;&#x5BF9;&#x7528;&#x6237;&#x662F;&#x900F;&#x660E;&#x7684;</strong>&#xFF0C;&#x4EFB;&#x4F55;&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x6216;&#x8005;&#x5728;server&#x4E0A;&#x7684;&#x7A0B;&#x5E8F;&#xFF0C;&#x90FD;&#x80FD;&#x591F;&#x8BBF;&#x95EE;&#x5F97;&#x4E86;&#x8FD9;&#x4E00;&#x903B;&#x8F91;&#x5730;&#x5740;&#xFF0C;&#x901A;&#x8FC7;server&#x7684;&#x4F5C;&#x4E3A;&#x5165;&#x53E3;&#x8BBF;&#x95EE;&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x8FD9;&#x662F;&#x5185;&#x7F51;&#x7A7F;&#x900F;&#xFF0C;&#x901A;&#x8FC7;&#x5BA2;&#x6237;&#x7AEF;A&#x7ECF;&#x8FC7;&#x670D;&#x52A1;&#x5668;&#x8BBF;&#x95EE;&#x5BA2;&#x6237;&#x7AEF;B&#xFF0C;&#x8FD9;&#x662F;&#x7EC4;&#x7F51;&#x3002;&#x8FD9;&#x91CC;&#x9762;&#x6709;&#x4E00;&#x4E2A;&#x7EC6;&#x8282;&#x9700;&#x8981;&#x8003;&#x7A76;&#xFF0C;&#x5C31;&#x662F;&#x600E;&#x4E48;&#x8BA9;&#x53E6;&#x4E00;&#x5BA2;&#x6237;&#x7AEF;&#x6216;&#x8005;server&#x7684;&#x6570;&#x636E;&#x8D70;&#x5230;&#x76EE;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x8FD9;&#x91CC;&#x8BF4;&#x7684;&#x662F;&#x6570;&#x636E;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x5E94;&#x7528;&#x5C42;&#x6570;&#x636E;&#xFF0C;&#x4E0D;&#x5305;&#x542B;IP&#x5934;&#x548C;TCP/UDP/ICMP&#x5934;&#x7684;&#x3002;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x9879;&#x76EE;<a href="https://github.com/ICKelin/inject_conntrack">inject_conntrack</a>&#x6216;&#x8BB8;&#x80FD;&#x591F;&#x6D3E;&#x4E0A;&#x7528;&#x573A;</p>
<p>&#x7528;&#x4E00;&#x4E2A;&#x56FE;&#x53EF;&#x4EE5;&#x8868;&#x793A;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://user-images.githubusercontent.com/9639491/51428993-f416ce80-1c44-11e9-825c-a95674a7839b.png" alt="image"></p>
<p>&#x5C31;notr&#x8FD9;&#x4E2A;&#x8F6F;&#x4EF6;&#x5F00;&#x53D1;&#x5F53;&#x524D;&#x5F00;&#x53D1;&#x800C;&#x8A00;&#x4E5F;&#x662F;&#x5B58;&#x5728;&#x4E00;&#x4E9B;&#x5E73;&#x53F0;&#x95EE;&#x9898;&#xFF0C;windows&#x7528;tap&#x7F51;&#x5361;&#xFF0C;linux/mac OS&#x7528;&#x7684;&#x662F;tun&#x7F51;&#x5361;&#x3002;&#x4EE3;&#x7801;&#x672C;&#x8EAB;&#x4E5F;&#x591A;&#x4E86;&#x5F88;&#x591A;&#x5E73;&#x53F0;&#x5224;&#x65AD;&#x7684;&#x903B;&#x8F91;&#xFF0C;&#x6240;&#x4EE5;&#x73B0;&#x5728;&#x56DE;&#x60F3;&#x8D77;&#x6765;&#x5F53;&#x521D;&#x8FD9;&#x4E48;&#x5FEB;&#x4E0B;&#x624B;&#x53BB;&#x5F00;&#x53D1;&#xFF0C;&#x4E5F;&#x4E0D;&#x77E5;&#x9053;&#x662F;&#x597D;&#x4E8B;&#x8FD8;&#x662F;&#x574F;&#x4E8B;&#xFF0C;&#x90FD;&#x6709;&#x5427;&#x3002;</p>
<p>&#x82B1;&#x4E86;&#x70B9;&#x65F6;&#x95F4;&#x9A8C;&#x8BC1;&#x4E0B;&#xFF0C;&#x53D1;&#x73B0;&#x8FD9;&#x4E2A;&#x601D;&#x8DEF;&#x505A;&#x5185;&#x7F51;&#x7A7F;&#x900F;&#x662F;&#x6CA1;&#x6709;&#x95EE;&#x9898;&#x7684;&#xFF0C;&#x8D34;&#x70B9;&#x4EE3;&#x7801;&#xFF0C;&#x4EC5;&#x4EC5;&#x662F;&#x9A8C;&#x8BC1;&#xFF0C;&#x4E3A;&#x4E86;&#x7B80;&#x5316;&#xFF0C;&#x90E8;&#x5206;&#x662F;&#x786C;&#x7F16;&#x7801;&#x8FDB;&#x53BB;&#x7684;&#xFF1A;</p>
<p>&#x5BA2;&#x6237;&#x7AEF;&#xFF1A;</p>
<p>&#x5BA2;&#x6237;&#x7AEF;&#x786C;&#x7F16;&#x7801;&#x4E86;&#x4EE3;&#x7406;&#x5230;127.0.0:8000&#x8FD9;&#x4E2A;&#x5730;&#x5740;&#xFF0C;&#x53EF;&#x4EE5;&#x4ECE;server&#x4F20;&#x9012;&#x8FC7;&#x6765;&#x7684;&#x3002;</p>
<pre data-role="codeBlock" data-info class="language-"><code>package main

import (
	&quot;flag&quot;
	&quot;fmt&quot;
	&quot;io&quot;
	&quot;net&quot;
	&quot;sync&quot;

	&quot;github.com/xtaci/smux&quot;
)

func main() {
	flgServer := flag.String(&quot;s&quot;, &quot;&quot;, &quot;server address&quot;)
	flag.Parse()

	conn, err := net.Dial(&quot;tcp&quot;, *flgServer)
	if err != nil {
		fmt.Println(err)
		return
	}

	sess, err := smux.Server(conn, nil)
	if err != nil {
		fmt.Println(err)
		return
	}

	for {
		stream, err := sess.AcceptStream()
		if err != nil {
			fmt.Println(err)
			return
		}

		go onStream(stream)
	}
}

func onStream(stream net.Conn) {
	remote, err := net.Dial(&quot;tcp&quot;, &quot;127.0.0.1:8000&quot;)
	if err != nil {
		fmt.Println(err)
		return
	}

	wg := &amp;sync.WaitGroup{}
	wg.Add(2)

	go func() {
		defer wg.Done()
		_, err := io.Copy(remote, stream)
		if err != nil {
			if err != io.EOF {
				fmt.Println(err)
			}
			return
		}
	}()

	go func() {
		defer wg.Done()
		_, err := io.Copy(stream, remote)
		if err != nil {
			if err != io.EOF {
				fmt.Println(err)
			}
			return
		}
	}()

	wg.Wait()
}

</code></pre><p>&#x670D;&#x52A1;&#x5668;&#xFF1A;</p>
<p>&#x670D;&#x52A1;&#x5668;&#x4E3B;&#x8981;&#x4E24;&#x4E2A;&#x90E8;&#x5206;&#xFF0C;&#x4E00;&#x90E8;&#x5206;&#x662F;&#x7ED9;&#x5176;&#x4ED6;&#x7A0B;&#x5E8F;&#x63A5;&#x5165;&#x7528;&#x7684;&#xFF0C;&#x6682;&#x4E14;&#x53EB;access&#xFF0C;&#x53E6;&#x4E00;&#x90E8;&#x5206;&#x662F;&#x7ED9;&#x5BA2;&#x6237;&#x7AEF;&#x7528;&#x7684;&#xFF0C;&#x6682;&#x4E14;&#x79F0;&#x4E4B;&#x4E3A;server&#x3002;</p>
<p>access.go&#x9700;&#x8981;&#x4F9D;&#x8D56;<a href="https://github.com/ICKelin/inject_conntrack">inject_conntrack</a></p>
<pre data-role="codeBlock" data-info class="language-"><code>package main

import (
	&quot;fmt&quot;
	&quot;io&quot;
	&quot;log&quot;
	&quot;net&quot;
	&quot;sync&quot;
	&quot;time&quot;

	&quot;github.com/smartwalle/going/logs&quot;
)

type Access struct {
	tcpListen string
	srv       *Server
}

func NewAccess(tcp string, srv *Server) *Access {
	return &amp;Access{
		tcpListen: tcp,
		srv:       srv,
	}
}

func (s *Access) Run() {
	s.tcp()
}

func (s *Access) tcp() error {
	conn, err := net.Listen(&quot;tcp&quot;, s.tcpListen)
	if err != nil {
		return err
	}

	for {
		client, err := conn.Accept()
		if err != nil {
			return err
		}

		go s.onTCP(client)
	}
}

func (s *Access) onTCP(conn net.Conn) {
	remoteIP, _, _, err := s.getRemote(conn)
	if err != nil {
		if err != io.EOF {
			log.Println(err)
		}
		return
	}

	stream, err := s.srv.GetStream(remoteIP)
	if err != nil {
		logs.Println(err)
		return
	}

	wg := &amp;sync.WaitGroup{}
	wg.Add(2)

	go func() {
		defer wg.Done()
		io.Copy(stream, conn)
	}()

	go func() {
		defer wg.Done()
		io.Copy(conn, stream)
	}()

	wg.Wait()
}

func (s *Access) getRemote(conn net.Conn) (string, int, int, error) {
	header := make([]byte, 8)

	timeoutAt := time.Now().Add(time.Second * 5)
	conn.SetReadDeadline(timeoutAt)
	nr, err := io.ReadFull(conn, header)
	conn.SetReadDeadline(time.Time{})
	if err != nil {
		return &quot;&quot;, 0, 0, err
	}

	if nr != 8 {
		return &quot;&quot;, 0, 0, fmt.Errorf(&quot;header length no match, expected 8 got %d&quot;, nr)
	}

	fmt.Println(header)
	originDst := fmt.Sprintf(&quot;%d.%d.%d.%d&quot;, header[0], header[1], header[2], header[3])
	originDstPort := int(header[4]) + int(header[5])&lt;&lt;8
	payloadlength := int(header[6]) + int(header[7])&lt;&lt;8

	return originDst, originDstPort, payloadlength, nil
}

</code></pre><p>server.go</p>
<pre data-role="codeBlock" data-info class="language-"><code>package main

import (
	&quot;errors&quot;
	&quot;fmt&quot;
	&quot;log&quot;
	&quot;net&quot;
	&quot;sync&quot;

	&quot;github.com/xtaci/smux&quot;
)

var (
	errNoRoute = errors.New(&quot;no route to host&quot;)
)

type ServerConfig struct {
	ListenAddr string
	Token      string
}

type Server struct {
	sync.Mutex
	listenAddr string
	token      string
	route      map[string]*smux.Session
	dhcp       *DHCP
}

func NewServer(c *ServerConfig) (*Server, error) {
	s := &amp;Server{
		listenAddr: c.ListenAddr,
		token:      c.Token,
		route:      make(map[string]*smux.Session),
	}

	dhcp, err := NewDHCP(&amp;DHCPConfig{
		gateway: &quot;100.64.240.1&quot;,
		mask:    &quot;255.255.255.0&quot;,
	})

	if err != nil {
		return nil, err
	}

	s.dhcp = dhcp
	return s, nil
}

func (s *Server) Run() error {
	conn, err := net.Listen(&quot;tcp&quot;, s.listenAddr)
	if err != nil {
		return err
	}

	for {
		client, err := conn.Accept()
		if err != nil {
			return err
		}

		go s.onConn(client)
	}
}

func (s *Server) onConn(conn net.Conn) error {
	s.Lock()
	defer s.Unlock()

	ip, err := s.dhcp.SelectIP(&quot;&quot;)
	if err != nil {
		return err
	}

	log.Printf(&quot;use %s for %s\n&quot;, ip, conn.RemoteAddr().String())
	sess, err := smux.Client(conn, nil)
	if err != nil {
		return err
	}

	s.route[ip] = sess
	return nil
}

func (s *Server) GetStream(peer string) (net.Conn, error) {
	s.Lock()
	defer s.Unlock()
	sess, ok := s.route[peer]
	if !ok {
		return nil, fmt.Errorf(&quot;%s %v&quot;, peer, errNoRoute.Error())
	}

	return sess.OpenStream()
}

</code></pre><p>&#x5176;&#x5B9E;&#x6211;&#x662F;&#x5F88;&#x70E6;&#x8D34;&#x4EE3;&#x7801;&#xFF0C;&#x4E0D;&#x8D34;&#x4EE3;&#x7801;&#x4E0D;&#x5BB9;&#x6613;&#x7406;&#x89E3;&#xFF0C;&#x8D34;&#x4EE3;&#x7801;&#x4E86;&#xFF0C;&#x5C31;&#x5F53;&#x524D;&#x5927;&#x73AF;&#x5883;&#xFF0C;&#x80FD;&#x5B9A;&#x4E0B;&#x6765;&#x8BFB;&#x4EE3;&#x7801;&#x7684;&#xFF0C;&#x597D;&#x50CF;&#x4E5F;&#x4E0D;&#x662F;&#x90A3;&#x4E48;&#x591A;&#x3002;</p>
<p>&#x8FD9;&#x4E2A;&#x9A8C;&#x8BC1;&#x7A0B;&#x5E8F;&#x8FD0;&#x884C;&#x622A;&#x56FE;&#xFF1A;</p>
<p><img src="https://user-images.githubusercontent.com/9639491/51437214-291f3180-1cd6-11e9-8944-339f8bae00d8.png" alt="image"></p>
<p><img src="https://user-images.githubusercontent.com/9639491/51437219-39cfa780-1cd6-11e9-96b9-eaf5ffdef93a.png" alt="image"></p>
<hr>
<p><strong>&#x76EE;&#x524D;&#x5229;&#x7528;&#x8FD9;&#x4E2A;&#x601D;&#x8DEF;&#x5B9E;&#x73B0;&#x7684;&#x5185;&#x7F51;&#x7A7F;&#x900F;&#x5DF2;&#x7ECF;&#x53D1;&#x5E03;&#x5728;<a href="http://www.notr.tech:8000/2.0.0-beta/">&#x8FD9;&#x91CC;</a></strong>&#xFF0C;&#x6709;&#x7F51;&#x53CB;&#x95EE;&#x5230;&#x8BE5;&#x5982;&#x4F55;&#x7EC4;&#x7F51;&#xFF0C;&#x5176;&#x5B9E;&#x7EC4;&#x7F51;&#x4E5F;&#x4E0D;&#x96BE;&#xFF0C;&#x4F46;&#x662F;&#x7EC4;&#x7F51;&#x662F;&#x4F9D;&#x8D56;&#x8FD9;&#x4E2A;&#x5185;&#x6838;&#x6A21;&#x5757;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x76EE;&#x524D;&#x7EC4;&#x7F51;&#x53EA;&#x80FD;&#x7528;&#x5728;linux&#x4E0B;&#x3002;&#x7EC4;&#x7F51;&#x53EA;&#x9700;&#x8981;&#x5C06;&#x539F;&#x672C;server&#x7684;inject_conntrack&#x6A21;&#x5757;&#x5B89;&#x88C5;&#x5728;access&#x4E0A;&#xFF0C;&#x5C06;&#x4E24;&#x6761;iptables&#x547D;&#x4EE4;&#x5728;access&#x4E0A;&#x6267;&#x884C;&#x5373;&#x53EF;&#x3002;</p>
<ul>
<li>
<p>&#x5F53;access1&#x5E0C;&#x671B;&#x4E0E;access2&#x7684;&#x901A;&#x8FC7;&#x5185;&#x7F51;ip&#x5EFA;&#x7ACB;&#x901A;&#x4FE1;&#x65F6;&#xFF0C;access1&#x4E0A;&#x7684;inject_conntrack&#x6A21;&#x5757;&#x5728;&#x6570;&#x636E;&#x5305;&#x5F00;&#x59CB;&#x90E8;&#x5206;&#x5C06;&#x9700;&#x8981;&#x8BBF;&#x95EE;&#x7684;access2&#x7684;&#x5730;&#x5740;&#x548C;&#x7AEF;&#x53E3;&#x52A0;&#x8FDB;&#x53BB;&#xFF0C;&#x5E76;&#x4E14;&#x7ECF;&#x8FC7;iptables&#x7684;nat.output&#x505A;dnat&#x5230;server&#x4E0A;&#x76D1;&#x542C;&#x7684;&#x7AEF;&#x53E3;</p>
</li>
<li>
<p>server&#x90E8;&#x5206;&#x5148;&#x5C06;access1&#x7684;inject_conntrack&#x63D2;&#x5165;&#x7684;&#x76EE;&#x7684;ip&#x8BFB;&#x53D6;&#x51FA;&#x6765;&#xFF0C;&#x7136;&#x540E;&#x627E;&#x5230;&#x8FD9;&#x4E2A;ip&#x5BF9;&#x5E94;&#x7684;&#x4E0A;&#x5C42;socket&#xFF0C;&#x5F80;&#x8FD9;&#x4E2A;socket&#x53D1;&#x9001;&#x6570;&#x636E;</p>
</li>
</ul>
<p>&#x6574;&#x4E2A;&#x601D;&#x8DEF;&#x7684;&#x6838;&#x5FC3;&#x5C31;&#x53EA;&#x6709;inject_conntrack&#x7684;&#x51E0;&#x5341;&#x884C;&#x4EE3;&#x7801;&#xFF0C;&#x8FD9;&#x4E2A;&#x6A21;&#x5757;&#x80FD;&#x591F;&#x8BA9;&#x7ECF;&#x8FC7;&#x7684;&#x6240;&#x6709;&#x7684;&#x70B9;&#x90FD;&#x77E5;&#x9053;&#x6570;&#x636E;&#x5305;&#x5728;nat&#x4E4B;&#x524D;&#x7684;&#x5730;&#x5740;&#x3002;</p>
<p>ALL<br>
ICKelin.</p>

      </div>
      
      
    
    
    
    
    
    
    
    
  
    </body></html>